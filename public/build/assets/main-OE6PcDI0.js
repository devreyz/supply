import{I as E,J as C}from"./queue-DX9w-n4L.js";const I="modulepreload",P=function(i){return"/build/"+i},x={},g=function(t,e,s){let a=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),n=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));a=Promise.allSettled(e.map(c=>{if(c=P(c),c in x)return;x[c]=!0;const d=c.endsWith(".css"),l=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${l}`))return;const u=document.createElement("link");if(u.rel=d?"stylesheet":I,d||(u.as="script"),u.crossOrigin="",u.href=c,n&&u.setAttribute("nonce",n),document.head.appendChild(u),d)return new Promise((p,m)=>{u.addEventListener("load",p),u.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(o){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=o,window.dispatchEvent(n),!n.defaultPrevented)throw o}return a.then(o=>{for(const n of o||[])n.status==="rejected"&&r(n.reason);return t().catch(r)})};async function B(){const i=new E("zepocket",2);return await i.defineTable("products",{keyPath:"id",autoIncrement:!1,timestamps:!0,indexes:[{name:"name",keyPath:"name"},{name:"brand",keyPath:"brand"},{name:"ean",keyPath:"ean",unique:!0},{name:"is_global",keyPath:"is_global"}]}),await i.defineTable("suppliers",{keyPath:"id",autoIncrement:!1,timestamps:!0,indexes:[{name:"name",keyPath:"name"},{name:"is_active",keyPath:"is_active"}]}),await i.defineTable("quotes",{keyPath:"id",autoIncrement:!1,timestamps:!0,indexes:[{name:"product_id",keyPath:"product_id"},{name:"supplier_id",keyPath:"supplier_id"},{name:"cost_price",keyPath:"cost_price"}]}),await i.defineTable("orders",{keyPath:"id",autoIncrement:!0,timestamps:!0,indexes:[{name:"supplier_id",keyPath:"supplier_id"},{name:"status",keyPath:"status"},{name:"server_id",keyPath:"server_id"}]}),await i.defineTable("order_items",{keyPath:"id",autoIncrement:!0,timestamps:!0,indexes:[{name:"order_id",keyPath:"order_id"},{name:"product_id",keyPath:"product_id"}]}),await i.defineTable("cart",{keyPath:"product_id",autoIncrement:!1,timestamps:!1,indexes:[{name:"supplier_id",keyPath:"supplier_id"}]}),await i.defineTable("settings",{keyPath:"key",autoIncrement:!1,timestamps:!1}),await i.init(),console.log("üíæ ZePocket Database inicializado"),i}class ${constructor(t){this.db=t}async getAllProducts(){return this.db.table("products").all()}async searchProducts(t){const e=t.toLowerCase();return this.db.table("products").where(s=>{var a,r,o;return((a=s.name)==null?void 0:a.toLowerCase().includes(e))||((r=s.brand)==null?void 0:r.toLowerCase().includes(e))||((o=s.ean)==null?void 0:o.includes(t))}).all()}async getProduct(t){return this.db.table("products").find(t)}async saveProduct(t){return await this.db.table("products").find(t.id)?this.db.table("products").update(t.id,t):this.db.table("products").insert(t)}async bulkSaveProducts(t){for(const e of t)await this.saveProduct(e)}async getAllSuppliers(t=!1){let e=this.db.table("suppliers");return t&&(e=e.where("is_active",!0)),e.all()}async getSupplier(t){return this.db.table("suppliers").find(t)}async saveSupplier(t){return await this.db.table("suppliers").find(t.id)?this.db.table("suppliers").update(t.id,t):this.db.table("suppliers").insert(t)}async deleteSupplier(t){return this.db.table("suppliers").delete(t)}async bulkSaveSuppliers(t){for(const e of t)await this.saveSupplier(e)}async getAllQuotes(){return this.db.table("quotes").all()}async getQuotesForProduct(t){return this.db.table("quotes").where("product_id",t).orderBy("cost_price","asc").all()}async getQuotesForSupplier(t){return this.db.table("quotes").where("supplier_id",t).all()}async getBestQuote(t){return(await this.getQuotesForProduct(t))[0]||null}async getQuote(t,e){return this.db.table("quotes").where(s=>s.product_id===t&&s.supplier_id===e).first()}async saveQuote(t){const e=await this.getQuote(t.product_id,t.supplier_id);return e?this.db.table("quotes").update(e.id,{...t,id:e.id,previous_price:e.cost_price}):this.db.table("quotes").insert(t)}async bulkSaveQuotes(t){for(const e of t)await this.saveQuote(e)}async getCart(){return this.db.table("cart").all()}async addToCart(t){const e=await this.db.table("cart").find(t.product_id);return e?this.db.table("cart").update(t.product_id,{...e,quantity:t.quantity||e.quantity,supplier_id:t.supplier_id||e.supplier_id,unit_cost:t.unit_cost||e.unit_cost}):this.db.table("cart").insert(t)}async updateCartItem(t,e){return this.db.table("cart").update(t,e)}async removeFromCart(t){return this.db.table("cart").delete(t)}async clearCart(){const t=await this.getCart();for(const e of t)await this.removeFromCart(e.product_id)}async getCartWithDetails(){const t=await this.getCart(),e=[];for(const s of t){const a=await this.getProduct(s.product_id),r=await this.getSupplier(s.supplier_id);e.push({...s,product:a,supplier:r,subtotal:s.quantity*s.unit_cost,profit:a!=null&&a.sale_price?(a.sale_price-s.unit_cost)*s.quantity:null})}return e}async getAllOrders(){return this.db.table("orders").orderBy("createdAt","desc").all()}async getOrder(t){return this.db.table("orders").find(t)}async saveOrder(t){return t.id?this.db.table("orders").update(t.id,t):this.db.table("orders").insert(t)}async getOrderItems(t){return this.db.table("order_items").where("order_id",t).all()}async saveOrderItem(t){return t.id?this.db.table("order_items").update(t.id,t):this.db.table("order_items").insert(t)}async getOrderWithDetails(t){const e=await this.getOrder(t);if(!e)return null;const s=await this.getOrderItems(t),a=await this.getSupplier(e.supplier_id),r=[];for(const o of s){const n=await this.getProduct(o.product_id);r.push({...o,product:n})}return{...e,supplier:a,items:r}}async bulkSaveOrders(t){for(const e of t)if(await this.saveOrder(e),e.items)for(const s of e.items)await this.saveOrderItem({...s,order_id:e.id})}async getSetting(t,e=null){const s=await this.db.table("settings").find(t);return(s==null?void 0:s.value)??e}async setSetting(t,e){return await this.db.table("settings").find(t)?this.db.table("settings").update(t,{key:t,value:e}):this.db.table("settings").insert({key:t,value:e})}async getLastSync(){return this.getSetting("last_sync")}async setLastSync(t){return this.setSetting("last_sync",t)}async clearAll(){await this.db.table("products").clear(),await this.db.table("suppliers").clear(),await this.db.table("quotes").clear(),await this.db.table("orders").clear(),await this.db.table("order_items").clear(),await this.db.table("cart").clear()}async exportBackup(){return{products:await this.getAllProducts(),suppliers:await this.getAllSuppliers(),quotes:await this.getAllQuotes(),orders:await this.getAllOrders(),cart:await this.getCart(),settings:await this.db.table("settings").all(),exportedAt:new Date().toISOString()}}async importBackup(t){if(t.products&&await this.bulkSaveProducts(t.products),t.suppliers&&await this.bulkSaveSuppliers(t.suppliers),t.quotes&&await this.bulkSaveQuotes(t.quotes),t.orders&&await this.bulkSaveOrders(t.orders),t.cart)for(const e of t.cart)await this.addToCart(e)}}class L{constructor(t,e,s={}){var a;this.db=t,this.queue=e,this.baseUrl=s.baseUrl||"/api",this.csrfToken=s.csrfToken||((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.content),this.onSyncStart=s.onSyncStart||(()=>{}),this.onSyncComplete=s.onSyncComplete||(()=>{}),this.onSyncError=s.onSyncError||(()=>{}),this.onProgress=s.onProgress||(()=>{})}get headers(){return{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":this.csrfToken,"X-Requested-With":"XMLHttpRequest"}}async request(t,e,s=null){const a=`${this.baseUrl}${e}`,r={method:t,headers:this.headers,credentials:"same-origin"};s&&(t==="POST"||t==="PUT"||t==="PATCH")&&(r.body=JSON.stringify(s));const o=await fetch(a,r);if(!o.ok){const n=await o.json().catch(()=>({message:"Erro de rede"}));throw new Error(n.message||`HTTP ${o.status}`)}return o.json()}async checkForUpdates(){const t=await this.db.getLastSync();try{return(await this.request("GET",`/sync/check?last_sync=${t||""}`)).needs_update}catch(e){return console.warn("üì° Erro ao verificar atualiza√ß√µes:",e),!1}}async pull(){var t,e,s,a,r,o,n,c;if(!navigator.onLine)return console.log("üì° Offline - pulando sincroniza√ß√£o"),!1;this.onSyncStart();try{this.onProgress(10,"Conectando ao servidor...");const d=await this.request("GET","/sync/pull");return this.onProgress(30,"Salvando produtos..."),(t=d.products)!=null&&t.length&&await this.db.bulkSaveProducts(d.products),this.onProgress(50,"Salvando fornecedores..."),(e=d.suppliers)!=null&&e.length&&await this.db.bulkSaveSuppliers(d.suppliers),this.onProgress(70,"Salvando cota√ß√µes..."),(s=d.quotes)!=null&&s.length&&await this.db.bulkSaveQuotes(d.quotes),this.onProgress(90,"Salvando pedidos..."),(a=d.orders)!=null&&a.length&&await this.db.bulkSaveOrders(d.orders),await this.db.setLastSync(d.sync_timestamp),this.onProgress(100,"Sincroniza√ß√£o completa!"),this.onSyncComplete(d),console.log("‚úÖ Sincroniza√ß√£o conclu√≠da:",{products:((r=d.products)==null?void 0:r.length)||0,suppliers:((o=d.suppliers)==null?void 0:o.length)||0,quotes:((n=d.quotes)==null?void 0:n.length)||0,orders:((c=d.orders)==null?void 0:c.length)||0}),!0}catch(d){return console.error("‚ùå Erro na sincroniza√ß√£o:",d),this.onSyncError(d),!1}}async push(t){if(!navigator.onLine){for(const e of t)await this.queue.dispatch("sync_change",e,{unique:!0});return{queued:!0}}try{return await this.request("POST","/sync/push",{changes:t})}catch(e){for(const s of t)await this.queue.dispatch("sync_change",s,{unique:!0});throw e}}async fullSync(){await this.queue.processAll();const t=await this.checkForUpdates();return t&&await this.pull(),t}async quickSync(){return await this.checkForUpdates()?this.pull():!1}}function T(i,t){i.defineAction("sync_change",async e=>{const s=e.data;return await t.request("POST","/sync/push",{changes:[s]})}),i.defineAction("create_product",async e=>await t.request("POST","/products",e.data)),i.defineAction("create_supplier",async e=>await t.request("POST","/suppliers",e.data)),i.defineAction("save_quote",async e=>await t.request("POST","/quotes",e.data)),i.defineAction("create_order",async e=>await t.request("POST","/orders",e.data)),i.defineAction("update_order",async e=>{const{id:s,...a}=e.data;return await t.request("PUT",`/orders/${s}`,a)}),console.log("üìã Sync actions registradas")}function q(i){const{db:t,queue:e,sync:s,spa:a}=i;i.searchProducts=async r=>!r||r.length<2?t.getAllProducts():t.searchProducts(r),i.saveProduct=async r=>{var n;const o=await t.saveProduct(r);return await e.dispatch("sync_change",{type:"product",action:r.id?"update":"create",data:r,local_id:(n=o.id)==null?void 0:n.toString()}),a==null||a.toastSuccess("Produto salvo!"),o},i.getSuppliers=async(r=!0)=>t.getAllSuppliers(r),i.saveSupplier=async r=>{var n;const o=await t.saveSupplier(r);return await e.dispatch("sync_change",{type:"supplier",action:r.id?"update":"create",data:r,local_id:(n=o.id)==null?void 0:n.toString()}),a==null||a.toastSuccess("Fornecedor salvo!"),o},i.deleteSupplier=async r=>{await t.deleteSupplier(r),await e.dispatch("sync_change",{type:"supplier",action:"delete",data:{id:r}}),a==null||a.toastSuccess("Fornecedor removido!")},i.getProductQuotes=async r=>t.getQuotesForProduct(r),i.saveQuote=async r=>{const o=await t.getQuote(r.product_id,r.supplier_id);o&&(r.previous_price=o.cost_price,r.price_variation=r.cost_price-o.cost_price);const n=await t.saveQuote({...r,last_quoted_at:new Date().toISOString()});if(r.sale_price!==void 0){const c=await t.getProduct(r.product_id);c&&await t.saveProduct({...c,sale_price:r.sale_price})}return await e.dispatch("sync_change",{type:"quote",action:o?"update":"create",data:r}),a==null||a.toastSuccess("Cota√ß√£o salva!"),n},i.getBestPrice=async r=>t.getBestQuote(r),i.getCart=async()=>t.getCart(),i.getCartWithDetails=async()=>t.getCartWithDetails(),i.addToCart=async(r,o=1)=>{if(!await t.getProduct(r))return a==null||a.toastError("Produto n√£o encontrado"),null;const c=await t.getBestQuote(r);if(!c)return a==null||a.toastError("Produto sem cota√ß√£o cadastrada"),null;const d=await t.addToCart({product_id:r,supplier_id:c.supplier_id,quantity:o,unit_cost:c.cost_price});return a==null||a.toastSuccess("Adicionado ao carrinho!"),i.emit("cart:updated"),d},i.updateCartItem=async(r,o)=>{if(o.supplier_id){const c=await t.getQuote(r,o.supplier_id);c&&(o.unit_cost=c.cost_price)}const n=await t.updateCartItem(r,o);return i.emit("cart:updated"),n},i.removeFromCart=async r=>{await t.removeFromCart(r),a==null||a.toastSuccess("Item removido!"),i.emit("cart:updated")},i.clearCart=async()=>{await t.clearCart(),i.emit("cart:updated")},i.getCartTotals=async()=>{const r=await t.getCartWithDetails();let o=0,n=0;for(const c of r)o+=c.subtotal||0,n+=c.profit||0;return{items:r,itemsCount:r.length,totalCost:o,totalProfit:n}},i.createOrderFromCart=async()=>{var c;const r=await t.getCartWithDetails();if(r.length===0)return a==null||a.toastError("Carrinho vazio!"),null;const o={};for(const d of r){const l=d.supplier_id;o[l]||(o[l]={supplier_id:l,supplier:d.supplier,items:[],total_amount:0,total_profit:0}),o[l].items.push(d),o[l].total_amount+=d.subtotal,o[l].total_profit+=d.profit||0}const n=[];for(const d in o){const l=o[d],u=await t.saveOrder({supplier_id:parseInt(d),status:"draft",total_amount:l.total_amount,total_profit:l.total_profit,generated_at:new Date().toISOString()});for(const p of l.items)await t.saveOrderItem({order_id:u.id,product_id:p.product_id,quantity:p.quantity,unit_cost_snapshot:p.unit_cost,unit_sale_snapshot:(c=p.product)==null?void 0:c.sale_price,subtotal:p.subtotal,profit_snapshot:p.profit});await e.dispatch("create_order",{supplier_id:parseInt(d),items:l.items.map(p=>{var m;return{product_id:p.product_id,quantity:p.quantity,unit_cost_snapshot:p.unit_cost,unit_sale_snapshot:(m=p.product)==null?void 0:m.sale_price}})}),n.push(u)}return await t.clearCart(),a==null||a.toastSuccess(`${n.length} pedido(s) criado(s)!`),i.emit("cart:updated"),i.emit("orders:updated"),n},i.getOrders=async()=>t.getAllOrders(),i.getOrderDetails=async r=>t.getOrderWithDetails(r),i.cloneOrderToCart=async r=>{const o=await t.getOrderWithDetails(r);if(!o){a==null||a.toastError("Pedido n√£o encontrado");return}await t.clearCart();for(const n of o.items){const c=await t.getBestQuote(n.product_id);await t.addToCart({product_id:n.product_id,supplier_id:(c==null?void 0:c.supplier_id)||o.supplier_id,quantity:n.quantity,unit_cost:(c==null?void 0:c.cost_price)||n.unit_cost_snapshot})}a==null||a.toastSuccess("Pedido clonado para o carrinho!"),i.emit("cart:updated")},i.generateWhatsappText=async r=>{var c,d,l;const o=await t.getOrderWithDetails(r);if(!o)return null;let n=`*PEDIDO DE COMPRA - ${((c=o.supplier)==null?void 0:c.name)||"Fornecedor"}*
`;n+=`Data: ${new Date().toLocaleDateString("pt-BR")}
`,n+=`----------------
`;for(const u of o.items){const p=(u.quantity*u.unit_cost_snapshot).toFixed(2);n+=`[${u.quantity}x] ${((d=u.product)==null?void 0:d.name)||"Produto"} (${((l=u.product)==null?void 0:l.unit)||"UN"}) - R$ ${p}
`}return n+=`----------------
`,n+=`*TOTAL: R$ ${o.total_amount.toFixed(2)}*`,n},i.sendOrderToWhatsapp=async r=>{var d;const o=await t.getOrderWithDetails(r);if(!o||!((d=o.supplier)!=null&&d.whatsapp_link)){a==null||a.toastError("Fornecedor sem WhatsApp cadastrado");return}const n=await i.generateWhatsappText(r),c=`${o.supplier.whatsapp_link}?text=${encodeURIComponent(n)}`;window.open(c,"_blank")},i.exportBackup=async()=>{const r=await t.exportBackup(),o=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),n=URL.createObjectURL(o),c=document.createElement("a");c.href=n,c.download=`zepocket_backup_${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(n),a==null||a.toastSuccess("Backup exportado!")},i.importBackup=async r=>new Promise((o,n)=>{const c=new FileReader;c.onload=async d=>{try{const l=JSON.parse(d.target.result);await t.importBackup(l),a==null||a.toastSuccess("Backup restaurado!"),i.emit("data:updated"),o(!0)}catch(l){a==null||a.toastError("Arquivo de backup inv√°lido"),n(l)}},c.onerror=()=>n(new Error("Erro ao ler arquivo")),c.readAsText(r)}),i.forceSync=async()=>{const r=a==null?void 0:a.toastLoading("Sincronizando...","Conectando ao servidor");try{await s.fullSync(),r&&(a==null||a.updateToast(r,{type:"success",title:"Sincronizado!",description:"Dados atualizados com sucesso",dismissible:!0,duration:3e3})),i.emit("data:updated")}catch(o){r&&(a==null||a.updateToast(r,{type:"error",title:"Erro na sincroniza√ß√£o",description:o.message,dismissible:!0}))}},console.log("‚ö° ZePocket actions registradas")}class w{constructor(t={}){this.options={autoSync:!0,syncInterval:6e4,...t},this.spa=t.spa||null,this.db=null,this.queue=null,this.sync=null,this._listeners=new Map,this._initialized=!1}async init(){if(this._initialized)return this;console.log("üöÄ Inicializando ZePocket...");try{const t=await B();return this.db=new $(t),this.queue=new C(t),await this.queue.init(),this.sync=new L(this.db,this.queue,{baseUrl:"/api",onSyncStart:()=>this.emit("sync:start"),onSyncComplete:e=>this.emit("sync:complete",e),onSyncError:e=>this.emit("sync:error",e),onProgress:(e,s)=>this.emit("sync:progress",{percent:e,message:s})}),T(this.queue,this.sync),q(this),this.options.autoSync&&this._setupAutoSync(),this._setupConnectivityListeners(),this._initialized=!0,console.log("‚úÖ ZePocket inicializado"),navigator.onLine&&setTimeout(()=>this.sync.quickSync(),1e3),this}catch(t){throw console.error("‚ùå Erro ao inicializar ZePocket:",t),t}}_setupAutoSync(){setInterval(async()=>{navigator.onLine&&document.visibilityState==="visible"&&await this.sync.quickSync()},this.options.syncInterval),window.addEventListener("online",async()=>{console.log("üåê Online - sincronizando..."),await this.sync.fullSync(),this.emit("online")})}_setupConnectivityListeners(){window.addEventListener("offline",()=>{var t;console.log("üì¥ Offline"),(t=this.spa)==null||t.toastWarning("Modo Offline","Altera√ß√µes ser√£o sincronizadas quando voltar online"),this.emit("offline")}),document.addEventListener("visibilitychange",async()=>{document.visibilityState==="visible"&&navigator.onLine&&await this.sync.quickSync()})}on(t,e){return this._listeners.has(t)||this._listeners.set(t,new Set),this._listeners.get(t).add(e),()=>this._listeners.get(t).delete(e)}off(t,e){this._listeners.has(t)&&this._listeners.get(t).delete(e)}emit(t,e=null){this._listeners.has(t)&&this._listeners.get(t).forEach(s=>{try{s(e)}catch(a){console.error(`Erro no listener ${t}:`,a)}})}getStatus(){var t,e;return{initialized:this._initialized,online:navigator.onLine,pendingJobs:((e=(t=this.queue)==null?void 0:t.pending())==null?void 0:e.length)||0}}}let h=null;function v(i={}){return h||(h=new w(i)),h}function _(){return h}typeof window<"u"&&(window.ZePocket=w,window.createZePocket=v,window.getZePocket=_);const k=Object.freeze(Object.defineProperty({__proto__:null,ZePocket:w,createZePocket:v,getZePocket:_},Symbol.toStringTag,{value:"Module"}));class S{constructor(t){this.app=t,this.db=t.db,this.spa=t.spa}formatCurrency(t){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t||0)}formatPercent(t){return`${(t||0).toFixed(1)}%`}renderProductCard(t,e=!1){const s=t.best_price?this.formatCurrency(t.best_price):"--";let a="";if(t.best_price&&t.sale_price>0){const o=t.sale_price-t.best_price,n=o>=0?"emerald":"red";a=`
                <span class="ml-2 text-[10px] font-bold text-${n}-600 bg-${n}-50 px-1.5 py-0.5 rounded">
                    Lucro: ${this.formatCurrency(o)}
                </span>
            `}let r="";if(t.price_variation!==void 0&&t.price_variation!==null){const o=t.price_variation>0;r=`
                <span class="text-[10px] font-bold ${o?"text-red-500":"text-emerald-500"}">
                    ${o?"‚ñ≤":"‚ñº"} ${this.formatCurrency(Math.abs(t.price_variation))}
                </span>
            `}return`
            <div class="bento-card p-3 flex items-center justify-between ${e?"border-emerald-500 ring-1 ring-emerald-500 bg-emerald-50/30":""}" 
                 data-product-id="${t.id}">
                <div class="flex-1">
                    <h3 class="font-bold text-slate-800 text-sm">${t.name}</h3>
                    <div class="flex gap-2 text-xs text-slate-500 mt-0.5">
                        ${t.brand?`<span class="bg-slate-100 px-1.5 rounded">${t.brand}</span>`:""}
                        <span class="bg-slate-100 px-1.5 rounded">${t.unit||"UN"}</span>
                    </div>
                    <div class="mt-2 text-xs flex items-center flex-wrap gap-1">
                        <span class="text-slate-400 mr-1">Custo:</span> 
                        <span class="font-bold text-slate-700">${s}</span>
                        ${r}
                        ${a}
                    </div>
                </div>
                
                <button data-action="toggle-cart" data-id="${t.id}" 
                        class="ml-3 w-10 h-10 rounded-xl flex items-center justify-center transition-all 
                               ${t.best_price?"":"opacity-50 pointer-events-none"} 
                               ${e?"bg-emerald-100 text-emerald-600":"bg-slate-100 text-slate-400 hover:bg-emerald-500 hover:text-white"}">
                    <i data-lucide="${e?"check":"plus"}" class="w-5 h-5"></i>
                </button>
            </div>
        `}renderCartItem(t,e=[]){const{product:s,supplier:a,quantity:r,unit_cost:o,subtotal:n,profit:c}=t,d=e.map(l=>`
            <option value="${l.supplier_id}" ${l.supplier_id===t.supplier_id?"selected":""}>
                ${l.supplier_name||"Fornecedor"} (${this.formatCurrency(l.cost_price)})
            </option>
        `).join("");return`
            <div class="bento-card p-4 relative" data-cart-item="${t.product_id}">
                <button data-action="remove-from-cart" data-id="${t.product_id}" 
                        class="absolute top-4 right-4 text-red-400 hover:text-red-600">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
                
                <h3 class="font-bold text-slate-800 text-sm mb-3 pr-8">${(s==null?void 0:s.name)||"Produto"}</h3>

                <div class="grid grid-cols-1 gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Fornecedor</label>
                        <select data-action="update-cart-supplier" data-id="${t.product_id}" 
                                class="w-full bg-white border border-slate-200 text-xs font-medium p-2 rounded-lg outline-none focus:border-emerald-500">
                            ${d}
                        </select>
                    </div>

                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Qtd</label>
                            <div class="flex items-center">
                                <button data-action="update-cart-qty" data-id="${t.product_id}" data-qty="${r-1}" 
                                        class="w-8 h-8 bg-white border border-slate-200 rounded-l-lg hover:bg-slate-100">-</button>
                                <input type="number" readonly value="${r}" 
                                       class="w-full h-8 text-center bg-white border-y border-slate-200 text-sm font-bold text-slate-700">
                                <button data-action="update-cart-qty" data-id="${t.product_id}" data-qty="${r+1}" 
                                        class="w-8 h-8 bg-white border border-slate-200 rounded-r-lg hover:bg-slate-100">+</button>
                            </div>
                        </div>
                        <div class="flex-1 text-right">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Subtotal</label>
                            <div class="h-8 flex flex-col justify-center items-end leading-none">
                                <span class="text-slate-800 font-bold text-sm">${this.formatCurrency(n)}</span>
                                ${c!==null?`
                                    <span class="text-[10px] ${c>=0?"text-emerald-600":"text-red-500"} font-medium">
                                        Lucro: ${this.formatCurrency(c)}
                                    </span>
                                `:""}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `}renderOrderExportCard(t){const{supplier:e,items:s=[],total_amount:a,total_profit:r}=t;return`
            <div class="bento-card p-5">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-bold text-lg text-slate-800">${(e==null?void 0:e.name)||"Fornecedor"}</h3>
                        <p class="text-xs text-slate-500">${s.length} itens neste pedido</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-400 font-bold uppercase">Custo Total</p>
                        <p class="text-xl font-bold text-slate-800">${this.formatCurrency(a)}</p>
                    </div>
                </div>

                <div class="mb-4 bg-emerald-50 border border-emerald-100 p-2 rounded-lg flex justify-between items-center">
                    <span class="text-xs font-bold text-emerald-800 flex items-center gap-1">
                        <i data-lucide="trending-up" class="w-4 h-4"></i> Lucro Previsto:
                    </span>
                    <span class="text-sm font-black text-emerald-700">${this.formatCurrency(r)}</span>
                </div>

                <div class="flex gap-2">
                    <button data-action="view-order" data-id="${t.id}" 
                            class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition">
                        <i data-lucide="eye" class="w-4 h-4"></i> Detalhes
                    </button>
                    <button data-action="send-order-whatsapp" data-id="${t.id}" 
                            class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition">
                        <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
                    </button>
                </div>
            </div>
        `}renderSupplierCard(t,e=0){return`
            <div class="bento-card p-4 flex justify-between items-center" data-supplier-id="${t.id}">
                <div class="flex-1">
                    <h3 class="font-bold text-sm text-slate-800">${t.name}</h3>
                    ${t.contact_name?`<p class="text-xs text-slate-500">${t.contact_name}</p>`:""}
                    <div class="flex gap-2 mt-2">
                        ${t.phone?`
                            <a href="tel:${t.phone}" class="text-xs text-blue-600 hover:underline flex items-center gap-1">
                                <i data-lucide="phone" class="w-3 h-3"></i> ${t.phone}
                            </a>
                        `:""}
                        ${t.whatsapp?`
                            <a href="${t.whatsapp_link}" target="_blank" 
                               class="text-xs text-emerald-600 hover:underline flex items-center gap-1">
                                <i data-lucide="message-circle" class="w-3 h-3"></i> WhatsApp
                            </a>
                        `:""}
                    </div>
                    ${e>0?`
                        <span class="mt-2 inline-block text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">
                            ${e} cota√ß√µes
                        </span>
                    `:""}
                </div>
                <div class="flex gap-2">
                    <button data-action="edit-supplier" data-id="${t.id}" 
                            class="p-2 text-slate-400 hover:text-blue-600 transition">
                        <i data-lucide="pencil" class="w-4 h-4"></i>
                    </button>
                    <button data-action="delete-supplier" data-id="${t.id}" 
                            class="p-2 text-slate-400 hover:text-red-600 transition">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `}renderQuoteCard(t,e,s){const a=e!=null&&e.sale_price?((e.sale_price-t.cost_price)/e.sale_price*100).toFixed(1):null;let r="";return t.is_price_increase?r=`<span class="text-red-500 text-xs">‚ñ≤ +${this.formatCurrency(t.price_variation)}</span>`:t.is_price_decrease&&(r=`<span class="text-emerald-500 text-xs">‚ñº ${this.formatCurrency(t.price_variation)}</span>`),`
            <div class="bg-white border border-slate-200 p-3 rounded-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold text-slate-800 text-sm">${(e==null?void 0:e.name)||"Produto"}</h4>
                        <p class="text-xs text-slate-500">${(s==null?void 0:s.name)||"Fornecedor"}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-slate-800">${this.formatCurrency(t.cost_price)}</p>
                        ${r}
                    </div>
                </div>
                ${a!==null?`
                    <div class="mt-2 pt-2 border-t border-slate-100 flex justify-between text-xs">
                        <span class="text-slate-400">Venda: ${this.formatCurrency(e.sale_price)}</span>
                        <span class="font-bold ${parseFloat(a)>=0?"text-emerald-600":"text-red-500"}">
                            Margem: ${a}%
                        </span>
                    </div>
                `:""}
            </div>
        `}renderMarginCard(t,e){if(!t||!e)return"";const s=e-t,a=e>0?s/e*100:0;return`
            <div class="${s>0?"bg-emerald-100 text-emerald-800":s<0?"bg-red-100 text-red-800":"bg-slate-100 text-slate-800"} rounded-xl p-3 flex justify-between items-center transition-colors duration-300">
                <div>
                    <p class="text-[10px] font-bold uppercase tracking-wider opacity-60">Margem de Lucro</p>
                    <p class="text-xl font-black">${a.toFixed(1)}%</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold uppercase tracking-wider opacity-60">Lucro Unit√°rio</p>
                    <p class="text-lg font-bold">${this.formatCurrency(s)}</p>
                </div>
            </div>
        `}renderCartFooter(t){return`
            <div class="flex justify-between items-end mb-3 pb-3 border-b border-slate-700">
                <div>
                    <p class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">Custo Total</p>
                    <p class="text-xl font-bold text-white">${this.formatCurrency(t.totalCost)}</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] uppercase text-emerald-400 font-bold tracking-wider">Lucro Estimado</p>
                    <p class="text-lg font-bold text-emerald-400">${this.formatCurrency(t.totalProfit)}</p>
                </div>
            </div>
            <button data-action="create-order" 
                    class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold text-sm transition flex items-center justify-center gap-2">
                Finalizar Compra <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        `}renderEmptyState(t="Nenhum item encontrado",e="inbox"){return`
            <div class="text-center py-10 text-slate-400">
                <i data-lucide="${e}" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                <p>${t}</p>
            </div>
        `}refreshIcons(){typeof lucide<"u"&&lucide.createIcons()}}typeof window<"u"&&(window.ZePocketUI=S);class O{constructor(t=null){this.app=t||window.zepocket,this.ui=new S(this.app),this.currentQuoteProduct=null,this.currentOrderDetail=null,this.currentCompareProduct=null,this.init()}init(){document.addEventListener("DOMContentLoaded",()=>{this.bindEvents(),this.updateCartBadge()})}bindEvents(){document.addEventListener("click",s=>{const a=s.target.closest("[data-action]");if(!a)return;const r=a.dataset.action,o=a.dataset.id,n=a.dataset.value;this.handleAction(r,o,n,a)}),Object.entries({"catalog-search":s=>this.searchCatalog(s.target.value),"products-search":s=>this.filterProductsList(s.target.value),"quote-search":s=>this.handleQuoteSearch(s.target.value),"quote-cost-price":()=>this.calculateMargin(),"quote-sale-price":()=>this.calculateMargin(),"new-supplier-name":s=>{s.key==="Enter"&&this.quickAddSupplier()}}).forEach(([s,a])=>{const r=document.getElementById(s);if(r){const o=r.tagName==="INPUT"?"input":"change";r.addEventListener(o,a)}});const e=document.getElementById("import-backup-input");e&&e.addEventListener("change",s=>{var a;(a=s.target.files)!=null&&a[0]&&window.zepocket.importBackup(s.target.files[0])})}handleAction(t,e,s,a){var r,o,n,c,d,l,u,p,m,f,y,b;if(!this.app){console.error("ZePocket app not initialized");return}switch(t){case"switch-tab":this.switchCatalogTab(s);break;case"open-sheet":(r=this.app.spa)==null||r.openSheet(s);break;case"close-sheet":(o=this.app.spa)==null||o.closeSheet();break;case"toggle-cart":this.addToCart(e);break;case"remove-from-cart":this.removeFromCart(e);break;case"update-cart-qty":this.updateCartQuantity(e,a.dataset.qty);break;case"update-cart-supplier":this.updateCartSupplier(e,a.value);break;case"clear-cart":this.clearCart();break;case"create-order":this.finalizeOrders();break;case"reset-quote":this.resetQuoteForm();break;case"clear-quote":this.clearQuoteSelection();break;case"save-quote":this.saveQuote();break;case"select-quote-product":this.selectQuoteProduct(e);break;case"create-new-quote-product":this.createNewQuoteProduct(s);break;case"quick-add-supplier":this.quickAddSupplier();break;case"edit-supplier":this.editSupplier(e);break;case"delete-supplier":this.deleteSupplier(e);break;case"save-supplier":this.saveSupplier();break;case"open-add-product":this.openProductSheet();break;case"edit-product":this.editProduct(e);break;case"delete-product":this.deleteProduct(e);break;case"save-product":this.saveProduct();break;case"view-order":this.showOrderDetail(e);break;case"download-order-pdf":(c=(n=this.app).downloadOrderPDF)==null||c.call(n,e);break;case"send-order-whatsapp":(l=(d=this.app).sendOrderToWhatsapp)==null||l.call(d,e);break;case"copy-order-text":(p=(u=this.app).copyOrderText)==null||p.call(u,e);break;case"clone-order":this.cloneOrder(e);break;case"sync-data":(f=(m=this.app).forceSync)==null||f.call(m);break;case"export-backup":(b=(y=this.app).exportBackup)==null||b.call(y);break;case"clear-data":this.confirmClearData();break}}switchCatalogTab(t){["catalog","cart","export"].forEach(s=>{const a=document.getElementById(`btn-${s}-tab`),r=document.getElementById(`view-${s}-list`);a&&a.classList.toggle("active",s===t),r&&r.classList.toggle("hidden",s!==t)}),t==="catalog"&&this.loadCatalogProducts(),t==="cart"&&this.loadCartItems(),t==="export"&&this.loadExportOrders(),this.updateCartFooterVisibility(t==="cart")}async loadCatalogProducts(t=""){const e=document.getElementById("catalog-products-list");if(!e)return;const s=await window.zepocket.searchProducts(t),a=await window.zepocket.getCartItems(),r=new Set(a.map(o=>o.product_id));if(!s||s.length===0){e.innerHTML=this.ui.renderEmptyState("Nenhum produto encontrado","package");return}e.innerHTML=s.map(o=>this.ui.renderProductCard(o,r.has(o.id))).join(""),this.ui.refreshIcons()}searchCatalog(t){clearTimeout(this._catalogSearchTimeout),this._catalogSearchTimeout=setTimeout(()=>{this.loadCatalogProducts(t)},300)}async addToCart(t,e=1,s=null){await window.zepocket.addToCart(t,e,s),this.updateCartBadge(),this.showToast("Produto adicionado ao pedido")}async loadCartItems(){const t=document.getElementById("cart-items-list");if(!t)return;const e=await window.zepocket.getCartItems();if(!e||e.length===0){t.innerHTML=this.ui.renderEmptyState("Carrinho vazio","shopping-cart"),this.updateCartFooter(null);return}const s=await Promise.all(e.map(async a=>{const r=await window.zepocket.getProductQuotes(a.product_id);return this.ui.renderCartItem(a,r)}));t.innerHTML=s.join(""),this.updateCartFooter(e),this.ui.refreshIcons()}async updateCartQuantity(t,e){if(e<=0){await this.removeFromCart(t);return}await window.zepocket.updateCartItem(t,e),this.loadCartItems()}async removeFromCart(t){await window.zepocket.removeFromCart(t),this.loadCartItems(),this.updateCartBadge()}async clearCart(){confirm("Limpar todos os itens do carrinho?")&&(await window.zepocket.clearCart(),this.loadCartItems(),this.updateCartBadge())}updateCartFooter(t){const e=document.getElementById("cart-footer"),s=document.getElementById("cart-footer-content");if(!e||!s)return;if(!t||t.length===0){e.classList.add("hidden");return}const a=t.reduce((r,o)=>(r.totalCost+=o.subtotal||0,r.totalProfit+=o.profit||0,r),{totalCost:0,totalProfit:0});s.innerHTML=this.ui.renderCartFooter(a),e.classList.remove("hidden"),this.ui.refreshIcons()}updateCartFooterVisibility(t){const e=document.getElementById("cart-footer");e&&t?this.loadCartItems():e&&e.classList.add("hidden")}async updateCartBadge(){const t=await window.zepocket.getCartItems(),e=t?t.reduce((s,a)=>s+a.quantity,0):0;["catalog-cart-badge","tab-cart-badge"].forEach(s=>{const a=document.getElementById(s);a&&(e>0?(a.textContent=e,a.classList.remove("hidden")):a.classList.add("hidden"))})}async finishOrder(){const t=await window.zepocket.getCartItems();if(!t||t.length===0){this.showToast("Carrinho vazio!","error");return}const e={};t.forEach(s=>{const a=s.supplier_id||"sem_fornecedor";e[a]||(e[a]=[]),e[a].push(s)});for(const[s,a]of Object.entries(e))await window.zepocket.createOrderFromCart(s==="sem_fornecedor"?null:parseInt(s),a.map(r=>r.id));await window.zepocket.clearCart(),this.switchCatalogTab("export"),this.updateCartBadge(),this.showToast("Pedido(s) criado(s) com sucesso!","success")}async loadExportOrders(){const t=document.getElementById("export-orders-list");if(!t)return;const e=await window.zepocket.getOrders("draft");if(!e||e.length===0){t.innerHTML=this.ui.renderEmptyState("Nenhum pedido para exportar","file-text");return}t.innerHTML=e.map(s=>this.ui.renderOrderExportCard(s)).join(""),this.ui.refreshIcons()}async sendToWhatsapp(t){const e=await window.zepocket.generateWhatsappText(t);e.url&&(window.open(e.url,"_blank"),await window.zepocket.markOrderSent(t),this.loadExportOrders())}async generatePdf(t){const e=await window.zepocket.generateWhatsappText(t);e.text&&(await navigator.clipboard.writeText(e.text),this.showToast("Texto copiado! Cole no WhatsApp","success"))}async handleQuoteSearch(t){const e=document.getElementById("quote-suggestions");if(!e)return;if(t.length<2){e.classList.add("hidden");return}let a=(await window.zepocket.searchProducts(t)).map(r=>`
            <div data-action="select-quote-product" data-id="${r.id}" 
                 class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0">
                <p class="font-bold text-sm text-slate-800">${r.name}</p>
                <p class="text-xs text-slate-500">${r.brand||""} ${r.unit||""}</p>
            </div>
        `).join("");a+=`
            <div data-action="create-new-quote-product" data-value="${t}" 
                 class="p-3 bg-blue-50 hover:bg-blue-100 cursor-pointer flex items-center gap-2 text-blue-600">
                <i data-lucide="plus-circle" class="w-4 h-4"></i>
                <span class="font-bold text-sm">Cadastrar "${t}"</span>
            </div>
        `,e.innerHTML=a,e.classList.remove("hidden"),this.ui.refreshIcons()}async selectQuoteProduct(t){const s=(await window.zepocket.searchProducts("")).find(a=>a.id===t);s&&(this.currentQuoteProduct=s,document.getElementById("quote-suggestions").classList.add("hidden"),document.getElementById("quote-search").value=s.name,document.getElementById("quote-clear-btn").classList.remove("hidden"),document.getElementById("quote-form-area").classList.remove("hidden"),document.getElementById("quote-new-product-inputs").classList.add("hidden"),document.getElementById("quote-product-name").textContent=s.name,document.getElementById("quote-product-brand").textContent=s.brand||"Sem marca",document.getElementById("quote-product-unit").textContent=s.unit||"UN",document.getElementById("quote-product-ean").textContent=s.ean||"-",await this.loadSupplierOptions())}createNewQuoteProduct(t){this.currentQuoteProduct={id:null,name:t},document.getElementById("quote-suggestions").classList.add("hidden"),document.getElementById("quote-search").value=t,document.getElementById("quote-clear-btn").classList.remove("hidden"),document.getElementById("quote-form-area").classList.remove("hidden"),document.getElementById("quote-new-product-inputs").classList.remove("hidden"),document.getElementById("quote-new-name").value=t,document.getElementById("quote-product-name").textContent="Novo Produto",document.getElementById("quote-product-brand").textContent="-",document.getElementById("quote-product-unit").textContent="-",document.getElementById("quote-product-ean").textContent="-",this.loadSupplierOptions()}clearQuoteSelection(){this.currentQuoteProduct=null,document.getElementById("quote-search").value="",document.getElementById("quote-clear-btn").classList.add("hidden"),document.getElementById("quote-form-area").classList.add("hidden"),document.getElementById("quote-suggestions").classList.add("hidden"),this.resetQuoteForm()}resetQuoteForm(){document.getElementById("quote-search").value="",document.getElementById("quote-supplier").value="",document.getElementById("quote-cost-price").value="",document.getElementById("quote-sale-price").value="",document.getElementById("quote-margin-card").classList.add("hidden"),this.clearQuoteSelection()}async loadSupplierOptions(){const t=document.getElementById("quote-supplier");if(!t)return;const e=await window.zepocket.getSuppliers();t.innerHTML='<option value="">Selecione...</option>'+e.map(s=>`<option value="${s.id}">${s.name}</option>`).join("")}async checkPriceHistory(){if(!this.currentQuoteProduct||!this.currentQuoteProduct.id)return;const t=document.getElementById("quote-supplier").value;if(!t)return;const e=await window.zepocket.getQuotes(this.currentQuoteProduct.id,t),s=document.getElementById("quote-price-hint");if(e&&e.length>0){const a=e[0];s.classList.remove("hidden"),s.textContent=`√öltimo: R$ ${a.cost_price.toFixed(2)}`,document.getElementById("quote-cost-price").placeholder=a.cost_price.toFixed(2)}else s.classList.add("hidden")}calculateMargin(){const t=parseFloat(document.getElementById("quote-cost-price").value)||0,e=parseFloat(document.getElementById("quote-sale-price").value)||0,s=document.getElementById("quote-margin-card"),a=document.getElementById("quote-margin-percent"),r=document.getElementById("quote-profit-value");if(t>0&&e>0){const o=e-t,n=o/t*100;a.textContent=n.toFixed(1)+"%",r.textContent="R$ "+o.toFixed(2),s.classList.remove("hidden","bg-red-100","bg-yellow-100","bg-emerald-100"),n<10?s.classList.add("bg-red-100"):n<20?s.classList.add("bg-yellow-100"):s.classList.add("bg-emerald-100")}else s.classList.add("hidden")}async saveQuote(){var r;const t=document.getElementById("quote-supplier").value,e=parseFloat(document.getElementById("quote-cost-price").value),s=parseFloat(document.getElementById("quote-sale-price").value);if(!t){this.showToast("Selecione um fornecedor","error");return}if(!e||e<=0){this.showToast("Informe o pre√ßo de custo","error");return}let a=(r=this.currentQuoteProduct)==null?void 0:r.id;a||(a=(await window.zepocket.saveProduct({name:document.getElementById("quote-new-name").value,brand:document.getElementById("quote-new-brand").value,unit:document.getElementById("quote-new-unit").value||"UN",ean:document.getElementById("quote-new-ean").value,sale_price:s})).id),await window.zepocket.saveQuote({product_id:a,supplier_id:parseInt(t),cost_price:e,sale_price:s}),this.showToast("Cota√ß√£o registrada!","success"),this.resetQuoteForm(),window.spa&&window.spa.back()}async filterProducts(t){const e=document.getElementById("products-list");if(!e)return;const s=await window.zepocket.searchProducts(t);if(!s||s.length===0){e.innerHTML=this.ui.renderEmptyState("Nenhum produto","package");return}e.innerHTML=s.map(a=>`
            <div class="bento-card p-4 flex items-center justify-between cursor-pointer active:bg-slate-50" 
                 data-action="edit-product" data-id="${a.id}">
                <div class="flex-1">
                    <h4 class="font-bold text-slate-800">${a.name}</h4>
                    <p class="text-xs text-slate-500">${a.brand||"-"} ‚Ä¢ ${a.unit||"UN"}</p>
                    ${a.sale_price?`<p class="text-sm font-bold text-primary mt-1">Venda: R$ ${a.sale_price.toFixed(2)}</p>`:""}
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
            </div>
        `).join(""),this.ui.refreshIcons()}async editProduct(t){const s=(await window.zepocket.searchProducts("")).find(a=>a.id===t);s&&(document.getElementById("product-sheet-title").textContent="Editar Produto",document.getElementById("product-edit-id").value=s.id,document.getElementById("product-name").value=s.name,document.getElementById("product-brand").value=s.brand||"",document.getElementById("product-unit").value=s.unit||"UN",document.getElementById("product-ean").value=s.ean||"",document.getElementById("product-sale-price").value=s.sale_price||"",window.spa&&window.spa.openSheet("add-product"))}async saveProduct(){const t=document.getElementById("product-edit-id").value,e={name:document.getElementById("product-name").value,brand:document.getElementById("product-brand").value,unit:document.getElementById("product-unit").value,ean:document.getElementById("product-ean").value,sale_price:parseFloat(document.getElementById("product-sale-price").value)||null};if(!e.name){this.showToast("Nome √© obrigat√≥rio","error");return}t&&(e.id=parseInt(t)),await window.zepocket.saveProduct(e),this.showToast("Produto salvo!","success"),window.spa&&window.spa.closeSheet(),this.filterProducts(""),document.getElementById("product-sheet-title").textContent="Novo Produto",document.getElementById("product-edit-id").value="",document.getElementById("product-name").value="",document.getElementById("product-brand").value="",document.getElementById("product-unit").value="UN",document.getElementById("product-ean").value="",document.getElementById("product-sale-price").value=""}async loadSuppliers(){const t=document.getElementById("suppliers-list");if(!t)return;const e=await window.zepocket.getSuppliers();if(!e||e.length===0){t.innerHTML=this.ui.renderEmptyState("building-2","Nenhum fornecedor","Adicione seus distribuidores");return}t.innerHTML=e.map(s=>this.ui.renderSupplierCard(s,{onEdit:`zepocketViews.editSupplier(${s.id})`,onWhatsapp:s.whatsapp?`window.open('https://wa.me/55${s.whatsapp}', '_blank')`:null})).join(""),this.ui.refreshIcons()}async quickAddSupplier(){var s;const t=document.getElementById("new-supplier-name"),e=(s=t==null?void 0:t.value)==null?void 0:s.trim();if(!e){this.showToast("Digite o nome","error");return}await window.zepocket.saveSupplier({name:e,is_active:!0}),t.value="",this.loadSuppliers(),this.showToast("Fornecedor adicionado!","success")}async editSupplier(t){const s=(await window.zepocket.getSuppliers()).find(a=>a.id===t);s&&(document.getElementById("supplier-sheet-title").textContent="Editar Fornecedor",document.getElementById("supplier-edit-id").value=s.id,document.getElementById("supplier-name").value=s.name,document.getElementById("supplier-whatsapp").value=s.whatsapp||"",document.getElementById("supplier-notes").value=s.notes||"",document.getElementById("supplier-active").checked=s.is_active!==!1,window.spa&&window.spa.openSheet("add-supplier"))}async saveSupplier(){const t=document.getElementById("supplier-edit-id").value,e={name:document.getElementById("supplier-name").value,whatsapp:document.getElementById("supplier-whatsapp").value,notes:document.getElementById("supplier-notes").value,is_active:document.getElementById("supplier-active").checked};if(!e.name){this.showToast("Nome √© obrigat√≥rio","error");return}t&&(e.id=parseInt(t)),await window.zepocket.saveSupplier(e),this.showToast("Fornecedor salvo!","success"),window.spa&&window.spa.closeSheet(),this.loadSuppliers(),document.getElementById("supplier-sheet-title").textContent="Novo Fornecedor",document.getElementById("supplier-edit-id").value="",document.getElementById("supplier-name").value="",document.getElementById("supplier-whatsapp").value="",document.getElementById("supplier-notes").value="",document.getElementById("supplier-active").checked=!0}async filterOrders(t){const e=document.getElementById("orders-list");if(!e)return;document.querySelectorAll(".order-filter-btn").forEach(a=>{a.classList.toggle("active",a.textContent.toLowerCase().includes(t==="all"?"todos":t))});const s=await window.zepocket.getOrders(t==="all"?null:t);if(!s||s.length===0){e.innerHTML=this.ui.renderEmptyState("history","Nenhum pedido encontrado","Crie pedidos no cat√°logo");return}e.innerHTML=s.map(a=>`
            <div class="bento-card p-4 cursor-pointer active:bg-slate-50" 
                 data-action="view-order" data-id="${a.id}">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-bold text-slate-800">${a.supplier_name||"Sem fornecedor"}</h4>
                        <p class="text-xs text-slate-500">${new Date(a.created_at).toLocaleDateString("pt-BR")}</p>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-lg ${this.getStatusClass(a.status)}">${this.getStatusLabel(a.status)}</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                    <span class="text-sm text-slate-600">${a.items_count||0} itens</span>
                    <span class="font-bold text-primary">R$ ${(a.total_amount||0).toFixed(2)}</span>
                </div>
            </div>
        `).join(""),this.ui.refreshIcons()}getStatusClass(t){const e={draft:"bg-slate-200 text-slate-600",sent:"bg-blue-100 text-blue-600",completed:"bg-emerald-100 text-emerald-600",cancelled:"bg-red-100 text-red-600"};return e[t]||e.draft}getStatusLabel(t){return{draft:"Rascunho",sent:"Enviado",completed:"Conclu√≠do",cancelled:"Cancelado"}[t]||t}async showOrderDetail(t){const s=(await window.zepocket.getOrders()).find(r=>r.id===t);if(!s)return;this.currentOrderDetail=s,document.getElementById("order-detail-id").textContent=s.id,document.getElementById("order-detail-status").textContent=this.getStatusLabel(s.status),document.getElementById("order-detail-status").className=`text-xs px-2 py-1 rounded-lg ${this.getStatusClass(s.status)}`,document.getElementById("order-detail-supplier").textContent=s.supplier_name||"-",document.getElementById("order-detail-whatsapp").textContent=s.supplier_whatsapp?`üì± ${s.supplier_whatsapp}`:"-",document.getElementById("order-detail-total").textContent=`R$ ${(s.total_amount||0).toFixed(2)}`,document.getElementById("order-detail-profit").textContent=`R$ ${(s.total_profit||0).toFixed(2)}`,document.getElementById("order-detail-date").textContent=new Date(s.created_at).toLocaleString("pt-BR");const a=document.getElementById("order-detail-items");s.items&&s.items.length>0?a.innerHTML=s.items.map(r=>`
                <div class="bg-slate-50 p-3 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-sm text-slate-800">${r.product_name}</p>
                        <p class="text-xs text-slate-500">${r.quantity}x R$ ${(r.unit_cost||0).toFixed(2)}</p>
                    </div>
                    <span class="font-bold text-slate-800">R$ ${(r.subtotal||0).toFixed(2)}</span>
                </div>
            `).join(""):a.innerHTML='<p class="text-center text-slate-400 text-sm py-4">Sem itens</p>',window.spa&&window.spa.openSheet("order-detail")}async cloneOrder(){this.currentOrderDetail&&(await window.zepocket.cloneOrderToCart(this.currentOrderDetail.id),window.spa&&window.spa.closeSheet(),this.showToast("Itens adicionados ao carrinho!","success"),this.updateCartBadge())}async sendOrderWhatsapp(){this.currentOrderDetail&&(await this.sendToWhatsapp(this.currentOrderDetail.id),window.spa&&window.spa.closeSheet())}async showPriceCompare(t){const s=(await window.zepocket.searchProducts("")).find(n=>n.id===t);if(!s)return;this.currentCompareProduct=s,document.getElementById("compare-product-name").textContent=s.name,document.getElementById("compare-product-brand").textContent=s.brand||"-";const a=await window.zepocket.getQuotes(t),r=document.getElementById("compare-prices-list"),o=document.getElementById("compare-best-option");if(!a||a.length===0)r.innerHTML=this.ui.renderEmptyState("receipt","Sem cota√ß√µes","Registre pre√ßos para este produto"),o.classList.add("hidden");else{const n={};a.forEach(d=>{(!n[d.supplier_id]||new Date(d.quoted_at)>new Date(n[d.supplier_id].quoted_at))&&(n[d.supplier_id]=d)});const c=Object.values(n).sort((d,l)=>d.cost_price-l.cost_price);if(r.innerHTML=c.map((d,l)=>`
                <div class="p-3 rounded-xl ${l===0?"bg-emerald-50 border border-emerald-200":"bg-slate-50"} flex justify-between items-center">
                    <div>
                        <p class="font-bold text-sm ${l===0?"text-emerald-800":"text-slate-800"}">${d.supplier_name}</p>
                        <p class="text-[10px] text-slate-500">${new Date(d.quoted_at).toLocaleDateString("pt-BR")}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-lg ${l===0?"text-emerald-600":"text-slate-700"}">R$ ${d.cost_price.toFixed(2)}</p>
                        ${d.price_variation?`<p class="text-[10px] ${d.price_variation>0?"text-red-500":"text-emerald-500"}">${d.price_variation>0?"‚Üë":"‚Üì"} ${Math.abs(d.price_variation).toFixed(1)}%</p>`:""}
                    </div>
                </div>
            `).join(""),c.length>0){const d=c[0];if(document.getElementById("compare-best-supplier").textContent=d.supplier_name,document.getElementById("compare-best-price").textContent=`R$ ${d.cost_price.toFixed(2)}`,c.length>1){const l=c[c.length-1].cost_price-d.cost_price;document.getElementById("compare-best-savings").textContent=`Economia de R$ ${l.toFixed(2)} vs pior pre√ßo`}else document.getElementById("compare-best-savings").textContent="√önico fornecedor cotado";o.classList.remove("hidden")}}window.spa&&window.spa.openSheet("price-compare"),this.ui.refreshIcons()}async addBestToCart(){if(!this.currentCompareProduct)return;const t=await window.zepocket.getQuotes(this.currentCompareProduct.id);if(!t||t.length===0)return;const e=t.reduce((s,a)=>a.cost_price<s.cost_price?a:s,t[0]);await this.addToCart(this.currentCompareProduct.id,1,e.supplier_id),window.spa&&window.spa.closeSheet()}async loadSettingsData(){const t=await window.zepocket.getCounts();document.getElementById("count-products").textContent=t.products||0,document.getElementById("count-suppliers").textContent=t.suppliers||0,document.getElementById("count-quotes").textContent=t.quotes||0,document.getElementById("count-orders").textContent=t.orders||0;const e=await window.zepocket.getLastSyncTime();document.getElementById("last-sync-time").textContent=e?new Date(e).toLocaleString("pt-BR"):"Nunca"}async confirmClearData(){confirm(`‚ö†Ô∏è ATEN√á√ÉO!

Isso ir√° apagar TODOS os dados locais.
Esta a√ß√£o n√£o pode ser desfeita.

Deseja continuar?`)&&confirm("Tem certeza ABSOLUTA? Todos os dados ser√£o perdidos!")&&(await window.zepocket.clearAllData(),this.showToast("Dados apagados","success"),this.loadSettingsData())}async loadHomeData(){const t=await window.zepocket.getCounts();document.getElementById("home-count-products").textContent=t.products||0,document.getElementById("home-count-suppliers").textContent=t.suppliers||0,document.getElementById("home-count-orders").textContent=t.orders||0;const e=new Date;document.getElementById("summary-month").textContent=e.toLocaleDateString("pt-BR",{month:"short",year:"numeric"}).toUpperCase();const s=await window.zepocket.getMonthSummary();document.getElementById("summary-total").textContent=`R$ ${(s.total||0).toFixed(2)}`,document.getElementById("summary-profit").textContent=`R$ ${(s.profit||0).toFixed(2)}`,document.getElementById("summary-orders-count").textContent=s.count||0,await this.loadRecentQuotes(),this.updateSyncStatus()}async loadRecentQuotes(){const t=document.getElementById("home-recent-quotes");if(!t)return;const e=await window.zepocket.getRecentQuotes(5);if(!e||e.length===0){t.innerHTML=`
                <div class="text-center py-8 text-slate-400 text-sm">
                    <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                    <p>Nenhuma cota√ß√£o recente</p>
                </div>
            `,this.ui.refreshIcons();return}t.innerHTML=e.map(s=>this.ui.renderQuoteCard(s)).join(""),this.ui.refreshIcons()}showAllQuotes(){this.showToast("Em breve!","info")}updateSyncStatus(){const t=document.getElementById("sync-status-icon"),e=document.getElementById("sync-status-text");navigator.onLine?(t.classList.remove("bg-slate-300","bg-red-500"),t.classList.add("bg-emerald-500"),e.textContent="Online"):(t.classList.remove("bg-slate-300","bg-emerald-500"),t.classList.add("bg-red-500"),e.textContent="Offline")}showToast(t,e="info"){if(window.spa&&window.spa.toast){window.spa.toast(t,e);return}const s=document.createElement("div");s.className=`fixed bottom-20 left-4 right-4 max-w-lg mx-auto p-4 rounded-xl text-white font-bold text-center z-[100] transition-all transform translate-y-full opacity-0 ${e==="error"?"bg-red-500":e==="success"?"bg-emerald-500":"bg-slate-800"}`,s.textContent=t,document.body.appendChild(s),requestAnimationFrame(()=>{s.classList.remove("translate-y-full","opacity-0")}),setTimeout(()=>{s.classList.add("translate-y-full","opacity-0"),setTimeout(()=>s.remove(),300)},3e3)}onPageShow(t){switch(!this.app&&window.zepocket&&(this.app=window.zepocket),t){case"page-zepocket":this.loadHomeData();break;case"page-catalog":this.switchCatalogTab("catalog"),this.updateCartBadge();break;case"page-products":this.filterProducts("");break;case"page-suppliers":this.loadSuppliers();break;case"page-orders":this.filterOrders("all");break;case"page-zepocket-settings":this.loadSettingsData();break}}}typeof document<"u"&&(document.addEventListener("spa:pageshow",i=>{var t;window.zepocketViews&&window.zepocketViews.onPageShow((t=i.detail)==null?void 0:t.pageId)}),window.addEventListener("online",()=>{window.zepocketViews&&window.zepocketViews.updateSyncStatus()}),window.addEventListener("offline",()=>{window.zepocketViews&&window.zepocketViews.updateSyncStatus()}));const z=Object.freeze(Object.defineProperty({__proto__:null,ZePocketViews:O},Symbol.toStringTag,{value:"Module"}));async function F(i,t={}){const{createZePocket:e}=await g(async()=>{const{createZePocket:r}=await Promise.resolve().then(()=>k);return{createZePocket:r}},void 0),{ZePocketViews:s}=await g(async()=>{const{ZePocketViews:r}=await Promise.resolve().then(()=>z);return{ZePocketViews:r}},void 0),a=e({spa:i,...t});return await a.init(),window.zepocket=a,window.zepocketViews=new s(a),document.getElementById("page-zepocket")&&window.zepocketViews.loadHomeData(),a}document.addEventListener("DOMContentLoaded",async()=>{if(typeof window.spa<"u")await F(window.spa,{apiBase:"/api/zepocket",autoSync:!0,syncInterval:6e4}),console.log("‚úÖ ZePocket initialized with SPA");else{const{createZePocket:i}=await g(async()=>{const{createZePocket:e}=await Promise.resolve().then(()=>k);return{createZePocket:e}},void 0),t=i({apiBase:"/api/zepocket",autoSync:!0});await t.init(),window.zepocket=t,console.log("‚úÖ ZePocket initialized standalone")}window.zepocketViews&&document.getElementById("page-zepocket")&&window.zepocketViews.loadHomeData()});
